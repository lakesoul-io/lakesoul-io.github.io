"use strict";(self.webpackChunklakesoul_website=self.webpackChunklakesoul_website||[]).push([[7883],{4122:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Usage Docs/workspace-and-rbac","title":"Multi-tenant: Workspace and Role Permission Control","description":"Supported since 2.4.","source":"@site/docs/03-Usage Docs/12-workspace-and-rbac.md","sourceDirName":"03-Usage Docs","slug":"/Usage Docs/workspace-and-rbac","permalink":"/docs/Usage Docs/workspace-and-rbac","draft":false,"unlisted":false,"editUrl":"https://github.com/lakesoul-io/LakeSoul/tree/main/website/docs/03-Usage Docs/12-workspace-and-rbac.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"LakeSoul\'s Supports for Python and Machine Learning","permalink":"/docs/Usage Docs/machine-learning-support"},"next":{"title":"Use Kyuubi JDBC to Access Lakesoul\'s Table","permalink":"/docs/Usage Docs/setup-kyuubi"}}');var n=a(4848),o=a(8453);const r={},i="Multi-tenant: Workspace and Role Permission Control",c={},l=[{value:"The Relationship Between Workspace, Default Roles and Databases/Tables",id:"the-relationship-between-workspace-default-roles-and-databasestables",level:2},{value:"Enable Multi-Tenancy and Role Permission Control",id:"enable-multi-tenancy-and-role-permission-control",level:2},{value:"Create Workspace",id:"create-workspace",level:2},{value:"Create a user in the workspace",id:"create-a-user-in-the-workspace",level:2},{value:"Configure User Access to LakeSoul",id:"configure-user-access-to-lakesoul",level:2},{value:"Use LakeSoul RBAC with storage systems",id:"use-lakesoul-rbac-with-storage-systems",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.header,{children:(0,n.jsx)(s.h1,{id:"multi-tenant-workspace-and-role-permission-control",children:"Multi-tenant: Workspace and Role Permission Control"})}),"\n",(0,n.jsx)(s.admonition,{type:"tip",children:(0,n.jsx)(s.p,{children:"Supported since 2.4."})}),"\n",(0,n.jsx)(s.p,{children:"LakeSoul supports multiple workspaces in the LakeHouse, and each workspace can have multiple users, divided into two roles: administrators and ordinary users. Data (including metadata and physical data) in different workspaces are isolated."}),"\n",(0,n.jsx)(s.p,{children:"In principle, LakeSoul uses PostgreSQL's Role and Row Level Security Policies (RLS row-level security policies) to achieve metadata isolation."}),"\n",(0,n.jsx)(s.p,{children:"In the case of multi-tenancy, each user is assigned a PG user. Through the control of RLS, the users can only read and write the metadata of the workspace to which they belongs (including namespace/table/partition/snapshot), but cannot read/modify metadata of other workspaces. Together with the hadoop user group, HDFS permission isolation can be achieved."}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"It is worth mentioning that LakeSoul's permission isolation is effective for SQL/Java/Scala/Python jobs submitted to the cluster. Users cannot access metadata and physical data in other workspaces programmatically. Traditionally, Ranger in the Hadoop system can only implement metadata isolation for requests submitted to HiveServer, and it is difficult to prevent users from directly accessing Hive metadata by submitting code to the cluster."})}),"\n",(0,n.jsx)(s.h2,{id:"the-relationship-between-workspace-default-roles-and-databasestables",children:"The Relationship Between Workspace, Default Roles and Databases/Tables"}),"\n",(0,n.jsx)(s.p,{children:"In each workspace, there will be administrators (admins) roles and ordinary users (users) roles. Only administrators can create and delete namespace (database). Administrators and users can create and read and write tables in the namespace under this workspace. When each namespace is created, the workspace to which the currently operating administrator belongs is the workspace to which the namespace belongs. The namespace and the workspace to which the table belongs cannot be modified after creation."}),"\n",(0,n.jsx)(s.h2,{id:"enable-multi-tenancy-and-role-permission-control",children:"Enable Multi-Tenancy and Role Permission Control"}),"\n",(0,n.jsxs)(s.p,{children:["By default, LakeSoul does not enable this feature. This feature can be enabled by executing ",(0,n.jsx)(s.code,{children:"script/meta_rbac_init.sql"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"PGPASSWORD=lakesoul_test psql -h localhost -p 5432 -U lakesoul_test -f script/meta_rbac_init.sql lakesoul_test\n"})}),"\n",(0,n.jsx)(s.p,{children:"The user connecting to PG here needs to be an administrator user with the permission to create Role and enable RLS. It can be modified according to the actual PG deployment (including the last database name)."}),"\n",(0,n.jsx)(s.h2,{id:"create-workspace",children:"Create Workspace"}),"\n",(0,n.jsxs)(s.p,{children:["LakeSoul provides a PLSQL script to create a workspace, located at ",(0,n.jsx)(s.code,{children:"script/meta_rbac_add_domain.sql"}),". The invoke method is:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"PGPASSWORD=lakesoul_test psql -h localhost -p 5432 -U lakesoul_test -f script/meta_rbac_add_domain.sql -v domain=\"'test_workspace'\"\n"})}),"\n",(0,n.jsx)(s.p,{children:"This script requires a PG administrator account to execute. The -v domain parameter is the name of the workspace to be created."}),"\n",(0,n.jsx)(s.h2,{id:"create-a-user-in-the-workspace",children:"Create a user in the workspace"}),"\n",(0,n.jsx)(s.p,{children:"implement:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"PGPASSWORD=lakesoul_test psql -h localhost -p 5432 -U lakesoul_test -f script/meta_rbac_add_user.sql -v domain=\"'test_workspace'\" -v user=\"'admin1'\" -v is_admin='true'\nPGPASSWORD=lakesoul_test psql -h localhost -p 5432 -U lakesoul_test -f script/meta_rbac_add_user.sql -v domain=\"'test_workspace'\" -v user=\"'user1'\" -v is_admin='false'\n"})}),"\n",(0,n.jsx)(s.p,{children:"This script requires a PG administrator account to execute. The domain parameter specifies the workspace to which the user belongs, the user parameter is the user name, and the is_admin parameter configures whether the user is an administrator or a user. Executing this script will assign the user a PG user with the corresponding workspace and role, and generate a random password for the PG connection. Subsequently, the user needs to use this username and password as parameters for the LakeSoul metadata connection. Users' passwords need to be kept securely by themselves and must not be leaked to others."}),"\n",(0,n.jsx)(s.h2,{id:"configure-user-access-to-lakesoul",children:"Configure User Access to LakeSoul"}),"\n",(0,n.jsxs)(s.p,{children:["Refer to the method in ",(0,n.jsx)(s.a,{href:"/docs/Usage%20Docs/setup-meta-env",children:"Metadata Configuration"})," and use the user's own username and password to establish a connection to the LakeSoul metadata database."]}),"\n",(0,n.jsxs)(s.p,{children:["At the same time, an additional configuration item needs to be added to specify the workspace. The user's workspace can be passed using the environment variable ",(0,n.jsx)(s.code,{children:"LAKESOUL_CURRENT_DOMAIN"})," or the JVM property ",(0,n.jsx)(s.code,{children:"lakesoul.current.domain"}),". After setting these parameters, Spark/Flink/Presto/Python jobs can achieve workspace division and metadata isolation."]}),"\n",(0,n.jsx)(s.h2,{id:"use-lakesoul-rbac-with-storage-systems",children:"Use LakeSoul RBAC with storage systems"}),"\n",(0,n.jsxs)(s.p,{children:["In an HDFS cluster, it is also often necessary to isolate the physical data on HDFS. LakeSoul will automatically set  user and group of the namespace and table directory to the current user and workspace when creating a table. And set the namespace directory permissions to ",(0,n.jsx)(s.code,{children:"drwx-rwx-___"})," and the table directory permissions to ",(0,n.jsx)(s.code,{children:"drwx-r_x-___"})," (Currently only HDFS is supported. S3 support will be provided in the future)."]}),"\n",(0,n.jsxs)(s.p,{children:["In a multi-tenant Hadoop environment, it is recommended that each user be assigned a Linux user on the job submission client machine, synchronized with the Hadoop's user and group. And set the environment variables of the LakeSoul metadata connection for each user (can be added to each user's ",(0,n.jsx)(s.code,{children:"~/.bashrc"}),"). Users other than the cluster administrator should not have sudo permissions on the client machine."]}),"\n",(0,n.jsxs)(s.p,{children:["If you use a development environment such as Zeppelin, you can refer to Zeppelin's ",(0,n.jsx)(s.a,{href:"https://zeppelin.apache.org/docs/0.10.0/usage/interpreter/user_impersonation.html",children:"User Impersonation"})," function. When each user creates a Notebook, Zeppelin would automatically switch Linux users (via ",(0,n.jsx)(s.code,{children:"sudo -u"}),"). Other development tools can also implement similar mechanisms."]}),"\n",(0,n.jsxs)(s.p,{children:["For object storage systems like S3, LakeSoul provides the ",(0,n.jsx)(s.code,{children:"S3 Proxy"})," service to implement permission isolation for directories on object storage. ",(0,n.jsx)(s.code,{children:"S3 Proxy"})," uses a sidecar forwarding model to intercept S3 HTTP requests and, based on the current username, determine whether the user has permission to access the target table."]})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},8453:(e,s,a)=>{a.d(s,{R:()=>r,x:()=>i});var t=a(6540);const n={},o=t.createContext(n);function r(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:r(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);